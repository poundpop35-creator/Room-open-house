<script>
        // ข้อมูล JSON ชุดเดิม (ผมละไว้เพื่อความกระชับ ใช้ข้อมูลเดิมของคุณได้เลย)
        const rawGuestData = [ /* ... ข้อมูลเดิมของคุณ ... */ ];

        // กรองเอาเฉพาะข้อมูลที่มีลำดับ (ไม่ว่าง)
        const guestData = rawGuestData.filter(item => item['ลำดับ'] && item['ลำดับ'] !== "");

        const cardContainer = document.getElementById('cardContainer');
        const searchInput = document.getElementById('searchInput');
        const provinceFilter = document.getElementById('provinceFilter');
        const noResultMsg = document.getElementById('noResult');
        const summarySection = document.getElementById('summarySection');

        // --- ฟังก์ชันจัดการข้อมูล (Data Handling) ---

        // ฟังก์ชันคำนวณและแสดงผลสรุปยอดการเข้าพัก
        function calculateAndRenderSummary(data) {
            const summary = {};
            let totalRoomsAllHotels = 0;

            // วนลูปข้อมูลเพื่อนับจำนวน
            data.forEach(guest => {
                const hotel = guest['โรงแรม'] || 'ไม่ระบุโรงแรม';
                const stayType = guest['ประเภทการเข้าพัก'] || 'ไม่ระบุประเภท';

                if (!summary[hotel]) {
                    summary[hotel] = {
                        total: 0,
                        types: {}
                    };
                }
                if (!summary[hotel].types[stayType]) {
                    summary[hotel].types[stayType] = 0;
                }
                summary[hotel].types[stayType]++;
                summary[hotel].total++;
                totalRoomsAllHotels++;
            });

            // สร้าง HTML สำหรับส่วนสรุป
            summarySection.innerHTML = ''; 
            
            for (const hotel in summary) {
                const hotelData = summary[hotel];
                let typesHtml = '';
                const preferredOrder = ['พักเดี่ยว', 'พักคู่', 'พักเดี่ยว จ่ายส่วนต่าง'];
                
                preferredOrder.forEach(type => {
                    if (hotelData.types[type]) {
                         typesHtml += `
                            <div class="summary-item">
                                <span class="summary-label">
                                    <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background-color:${type === 'พักเดี่ยว' ? '#28a745' : (type === 'พักคู่' ? '#17a2b8' : '#ffc107')};"></span>
                                    ${type}
                                </span>
                                <span class="summary-count">${hotelData.types[type]} ห้อง</span>
                            </div>`;
                    }
                });

                for (const type in hotelData.types) {
                    if (!preferredOrder.includes(type)) {
                         typesHtml += `
                            <div class="summary-item">
                                <span class="summary-label">${type}</span>
                                <span class="summary-count">${hotelData.types[type]} ห้อง</span>
                            </div>`;
                    }
                }

                const cardHtml = `
                    <div class="summary-card">
                        <div class="summary-header">
                            <span><i class="fas fa-hotel"></i> ${hotel}</span>
                            <span class="summary-total-badge">รวม: ${hotelData.total} ห้อง</span>
                        </div>
                        <div class="summary-body">
                            ${typesHtml}
                        </div>
                    </div>
                `;
                summarySection.innerHTML += cardHtml;
            }
        }

        // ฟังก์ชันดึงรายชื่อจังหวัดทั้งหมด (ไม่ซ้ำ)
        function getUniqueProvinces(data) {
            const provinces = new Set();
            data.forEach(guest => {
                const prov = guest['จังหวัดที่ตั้งของหน่วยงาน'];
                if (prov && prov !== '-' && prov.trim() !== '') {
                    provinces.add(prov);
                }
            });
            return Array.from(provinces).sort((a, b) => a.localeCompare(b, 'th'));
        }

        // ฟังก์ชันสร้างตัวเลือกใน Dropdown
        function populateProvinceFilter(provinces) {
            provinces.forEach(prov => {
                const option = document.createElement('option');
                option.value = prov;
                option.textContent = prov;
                provinceFilter.appendChild(option);
            });
        }

        // --- [แก้ไขจุดที่ 1] ฟังก์ชันเรียงลำดับข้อมูลตาม "ลำดับ" ---
        function sortDataBySequence(data) {
            return [...data].sort((a, b) => {
                const seqA = parseInt(a['ลำดับ']) || 0;
                const seqB = parseInt(b['ลำดับ']) || 0;
                return seqA - seqB;
            });
        }

        // --- ฟังก์ชันแสดงผล (Render View) ---

        function renderCards(data) {
            cardContainer.innerHTML = '';
            if (data.length === 0) {
                noResultMsg.style.display = 'block';
                return;
            } else {
                noResultMsg.style.display = 'none';
            }

            data.forEach(guest => {
                const card = document.createElement('div');
                
                // เช็คสถานะยกเลิก
                const isCancelled = guest['ชื่อ - สกุล'].includes('ยกเลิก');
                card.className = isCancelled ? 'guest-card cancelled' : 'guest-card';
                
                let fullName1 = guest['ชื่อ - สกุล'] || '(ไม่ระบุชื่อ)';
                let dept1 = guest['หน่วยงาน'] || '-';
                let prov1 = guest['จังหวัดที่ตั้งของหน่วยงาน'] || '-';

                let fullName2 = guest['ชื่อ - สกุล__1'] || '-';
                let dept2 = guest['หน่วยงาน__1'] || '-';
                let prov2 = guest['จังหวัดที่ตั้งของหน่วยงาน__1'] || '-';
                
                const stayType = guest['ประเภทการเข้าพัก'] || '-';
                const isTwin = stayType === 'พักคู่';

                if (stayType.includes('เดี่ยว')) {
                    fullName2 = '-';
                }

                const hotel = guest['โรงแรม'] || '-';
                
                let roomNo = guest['เลขห้อง'] || '-';
                let roomNoClass = 'room-no'; 

                if (roomNo === 'รอเช็คอิน' || roomNo === 'รอ') {
                    if (roomNo === 'รอ') roomNo = 'รอเช็คอิน';
                    roomNoClass = 'room-no-waiting';
                }

                const carReg = guest['ทะเบียนรถรับลส่ง\nที่พัก - กรมวิทย์'] || '-';
                const departureTime = guest['เวลา\n(เริ่มออกจากโรงแรมตั้งแต่)'] || '-';
                
                // ข้อมูลเพิ่มเติม (Updated Layout)
                const hotelCoord = guest['ผู้ประสานงาน ที่ โรงแรม'] || '-';
                const contactPhone = guest['ติดต่อ'] || '-';
                const dmscCoord = guest['ผู้ประสานงาน ที่ กรม'] || '-';
                const note = guest['หมายเหตุ'] || '-';

                let stayTypeBadge = `<span class="badge">${stayType}</span>`;
                if (isCancelled) stayTypeBadge = `<span class="badge badge-cancel">ยกเลิกห้อง</span>`;
                else if(stayType === 'พักเดี่ยว') stayTypeBadge = `<span class="badge badge-single">${stayType}</span>`;
                else if (stayType.includes('จ่ายส่วนต่าง')) stayTypeBadge = `<span class="badge badge-single-pay">${stayType}</span>`;
                else if (isTwin) stayTypeBadge = `<span class="badge badge-twin">${stayType}</span>`;

                let roommateSection = '';
                if (isTwin && fullName2 && fullName2 !== '-' && fullName2.trim() !== '') {
                    roommateSection = `
                        <div class="roommate-section">
                            <div class="roommate-header-label">ผู้เข้าพักร่วม (รูมเมท)</div>
                            <div class="guest-name">${fullName2}</div>
                            <div class="org-prov-info"><i class="fas fa-building"></i> ${dept2} <span class="badge badge-prov">${prov2}</span></div>
                        </div>
                    `;
                }

                // สร้าง HTML ของการ์ด
                card.innerHTML = `
                    <div class="card-header">
                        <span class="seq-badge">ลำดับที่ ${guest['ลำดับ']}</span>
                        ${stayTypeBadge}
                    </div>
                    <div class="main-guest-info">
                        <div class="guest-name">${fullName1}</div>
                        <div class="org-prov-info"><i class="fas fa-building"></i> ${dept1} <span class="badge badge-prov">${prov1}</span></div>
                    </div>
                    
                    ${roommateSection}

                    <div class="details-section">
                        <div class="detail-item">
                            <div class="detail-label"><i class="fas fa-hotel"></i> โรงแรม</div>
                            <div class="detail-value">${hotel}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label"><i class="fas fa-key"></i> เลขห้อง</div>
                            <div class="detail-value ${roomNoClass}">${roomNo}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label"><i class="fas fa-bus"></i> รถรับส่ง (ทะเบียน)</div>
                            <div class="detail-value"><span class="badge badge-car">${carReg}</span></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label"><i class="far fa-clock"></i> เวลาออกเดินทาง</div>
                            <div class="detail-value time-slot">${departureTime}</div>
                        </div>
                        
                        <div class="detail-item full-width">
                             <div class="detail-label"><i class="fas fa-comment-alt"></i> หมายเหตุ</div>
                             <div class="detail-value" style="color: #666; font-style: italic;">${note}</div>
                        </div>
                    </div>

                    <div class="coord-section">
                        <div class="coord-title">
                            ข้อมูลผู้ประสานงาน
                            <span class="coord-contact-badge"><i class="fas fa-phone-alt"></i> ${contactPhone}</span>
                        </div>
                        <div class="coord-detail">
                            <span class="coord-label"><i class="fas fa-user-tie"></i> รอรับ ณ โรงแรม:</span> 
                            <span class="coord-phone">${hotelCoord}</span>
                        </div>
                        <div class="coord-detail">
                            <span class="coord-label"><i class="fas fa-user-shield"></i> รอรับ ณ กรมวิทย์:</span> 
                            <span class="coord-phone">${dmscCoord}</span>
                        </div>
                    </div>
                `;
                cardContainer.appendChild(card);
            });
        }

        // --- ฟังก์ชันกรองข้อมูล (Filter & Search) ---
        function filterAndSortGuests() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const selectedProvince = provinceFilter.value;

            // 1. กรองข้อมูล
            let filteredData = guestData.filter(guest => {
                // กรองตามจังหวัดที่เลือก (ถ้ามี)
                if (selectedProvince && guest['จังหวัดที่ตั้งของหน่วยงาน'] !== selectedProvince) {
                    return false;
                }

                // กรองตามคำค้นหา (ถ้ามี)
                if (searchTerm) {
                    let roommateInfo = "";
                    if (guest['ชื่อ - สกุล__1'] && guest['ชื่อ - สกุล__1'] !== '-') {
                        roommateInfo = `${guest['ชื่อ - สกุล__1']} ${guest['หน่วยงาน__1']} ${guest['จังหวัดที่ตั้งของหน่วยงาน__1']}`;
                    }

                    const searchableString = `
                        ${guest['ลำดับ'] || ''}
                        ${guest['ชื่อ - สกุล'] || ''}
                        ${guest['หน่วยงาน'] || ''}
                        ${guest['จังหวัดที่ตั้งของหน่วยงาน'] || ''}
                        ${roommateInfo}
                        ${guest['ประเภทการเข้าพัก'] || ''}
                        ${guest['โรงแรม'] || ''}
                        ${guest['เลขห้อง'] || ''}
                        ${guest['ทะเบียนรถรับลส่ง\nที่พัก - กรมวิทย์'] || ''}
                        ${guest['ติดต่อ'] || ''}
                    `.toLowerCase();
                    
                    if (!searchableString.includes(searchTerm)) {
                        return false;
                    }
                }
                return true;
            });

            // 2. [แก้ไขจุดที่ 2] เรียงลำดับข้อมูลตาม "ลำดับ"
            const sortedData = sortDataBySequence(filteredData);

            // 3. แสดงผลข้อมูลที่กรองและเรียงแล้ว
            renderCards(sortedData);
        }

        // --- Event Listeners ---
        searchInput.addEventListener('keyup', filterAndSortGuests);
        provinceFilter.addEventListener('change', filterAndSortGuests);

        // --- เริ่มต้นทำงาน ---
        const uniqueProvinces = getUniqueProvinces(guestData);
        populateProvinceFilter(uniqueProvinces);
        calculateAndRenderSummary(guestData);
        
        // [แก้ไขจุดที่ 3] เรียกใช้การเรียงตามลำดับตอนโหลดหน้าเว็บ
        const initialSortedData = sortDataBySequence(guestData);
        
        renderCards(initialSortedData);

    </script>
